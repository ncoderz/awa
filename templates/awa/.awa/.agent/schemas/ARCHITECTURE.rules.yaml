# Structural rules for ARCHITECTURE.md
target-files: ".awa/specs/ARCHITECTURE.md"
description: >
  High-level architecture overview for the project. Succinct language.
  Do not overspecify or include implementation details. Covers project purpose,
  system layers, technology stack, architecture diagram, directory structure,
  component details with RESPONSIBILITIES, interactions, rules, and
  developer commands. One file per project.
line-limit: 500

sections:
  # Top-level heading
  - heading: "Architecture"
    level: 1
    required: true
    description: "Document title. No metadata in this section."

  # Project Purpose section
  - heading: "Project Purpose"
    level: 2
    required: true
    description: >
      Single paragraph: core problem and primary functionality.
      What the project does and why it exists.

  # System Overview section
  - heading: "System Overview"
    level: 2
    required: true
    description: >
      Bullet list of software layers or subsystems (e.g., CLI Layer,
      Core Engine, Template System, I/O Layer).

  # Technology Stack section
  - heading: "Technology Stack"
    level: 2
    required: true
    description: >
      Bullet list of technologies with major version only.
      Format: - `{Technology N}` — {purpose}

  # High-Level Architecture section with mermaid diagram
  - heading: "High-Level Architecture"
    level: 2
    required: true
    description: >
      Mermaid diagram showing components, data flow, and dependencies.
      Must include a mermaid code block.
    contains:
      - code-block: true
        label: "architecture diagram (mermaid)"
        description: "Mermaid diagram (flowchart, sequence, etc.) showing the architecture."

  # Directory Structure section
  - heading: "Directory Structure"
    level: 2
    required: true
    description: >
      Code block with directory tree showing source layout.
      Format: path/  # description
    contains:
      - code-block: true
        label: "directory tree"
        description: "Plain text directory tree with inline comments."

  # Component Details section
  - heading: "Component Details"
    level: 2
    required: true
    description: >
      One H3 per major component. Each component has a single-sentence
      description, RESPONSIBILITIES list, and optional CONSTRAINTS list.
    children:
      - heading: ".*"
        level: 3
        repeatable: true
        required: true
        description: >
          Component heading. Contains a single-sentence description,
          RESPONSIBILITIES bullet list, and optional CONSTRAINTS bullet list.
        contains:
          - pattern: "RESPONSIBILITIES"
            label: "RESPONSIBILITIES section"
            description: "Keyword followed by a bullet list of component responsibilities."

  # Component Interactions section
  - heading: "Component Interactions"
    level: 2
    required: true
    description: >
      Describes how components communicate. May include mermaid sequence
      diagrams as H3 subsections.

  # Architectural Rules section
  - heading: "Architectural Rules"
    level: 2
    required: true
    description: >
      Bullet list of rules covering performance, scaling, maintainability,
      security, and testing constraints.

  # Release Status section (optional)
  - heading: "Release Status"
    level: 2
    description: >
      Current release phase (Alpha, Beta, RC, GA) with brief description.
      Format: STATUS: {phase} - {description}

  # Developer Commands section
  - heading: "Developer Commands"
    level: 2
    required: true
    description: >
      Bullet list of essential developer commands.
      Format: - `{command}` - {description}

  # Change Log section (optional)
  - heading: "Change Log"
    level: 2
    description: "Version history. Format: - {version} ({date}): {changes}"

sections-prohibited:
  - "**"

example: |
  # Architecture

  ## Project Purpose

  awa CLI generates AI coding agent configuration files from templates, enabling developers to quickly scaffold consistent agent setups across projects.

  ## System Overview

  - CLI Layer
  - Core Engine
  - Template System
  - I/O Layer

  ## Technology Stack

  - `Node.js 20` — Runtime environment
  - `TypeScript 5` — Type-safe development
  - `Eta 3` — Template rendering
  - `Citty` — CLI framework

  ## High-Level Architecture

  ```mermaid
  flowchart LR
      subgraph Input
          Args[CLI Args]
          Config[.awa.toml]
          Templates[Templates]
      end
      subgraph Core
          Parser[ArgumentParser]
          Engine[TemplateEngine]
          Generator[FileGenerator]
      end
      subgraph Output
          Files[Generated Files]
      end
      Args --> Parser
      Config --> Parser
      Parser --> Engine
      Templates --> Engine
      Engine --> Generator
      Generator --> Files
  ```

  ## Directory Structure

  ```
  src/           # Source code
  src/cli/       # CLI entry and commands
  src/core/      # Core engine logic
  src/utils/     # Shared utilities
  templates/     # Bundled templates
  ```

  ## Component Details

  ### CLI Layer

  Handles argument parsing and command dispatch.

  RESPONSIBILITIES

  - Parse CLI arguments and options
  - Load and merge configuration
  - Dispatch to appropriate command handlers

  CONSTRAINTS

  - Must fail fast on invalid arguments
  - Must support --help and --version

  ### Template Engine

  Renders templates with feature flag context.

  RESPONSIBILITIES

  - Load templates from local or remote sources
  - Render with Eta templating
  - Detect empty output for conditional file creation

  ### File Generator

  Writes rendered output to the file system.

  RESPONSIBILITIES

  - Write files with conflict detection
  - Support dry-run mode
  - Generate diff output

  ## Component Interactions

  The CLI parses arguments, loads configuration, then passes resolved options to the template engine which renders files through the generator.

  ### Generate Command Flow

  ```mermaid
  sequenceDiagram
      participant User
      participant CLI
      participant Engine
      participant Generator
      User->>CLI: awa generate
      CLI->>Engine: render(templates, features)
      Engine->>Generator: write(files)
      Generator-->>User: Success summary
  ```

  ## Architectural Rules

  - All file I/O must go through the I/O layer
  - Core engine must not depend on CLI layer
  - Templates must be stateless and deterministic
  - Errors must provide actionable messages with file paths
  - All public APIs must have TypeScript types

  ## Release Status

  STATUS: Alpha — Core functionality implemented. API may change without notice.

  ## Developer Commands

  - `npm install` — Install dependencies
  - `npm run dev` — Run in development mode
  - `npm test` — Run test suite
  - `npm run lint` — Run linter
  - `npm run build` — Build for production

  ## Change Log

  - 1.0.0 (2025-01-10): Initial architecture
  - 1.1.0 (2025-01-15): Added diff command
