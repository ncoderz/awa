{
  "$schema": "http://json-schema.org/draft-07/schema#",
  "title": "LLM Plan Schema",
  "description": "RENDERING RULES: Transform data, never transcribe field names. Use CAPITALS for emphasis (not **bold** or *italics*). Use lists instead of tables. Use mermaid for diagrams (not ASCII). Steps render with DEPENDS ON line if dependencies exist. ZERO DUPLICATION PRINCIPLE: Reference design/requirements by ID only. Never restate their content. PROHIBITED: 'FieldName: value' label patterns, nested bullets for simple fields, **bold** syntax, *italic* syntax, tables, ASCII diagrams.",
  "type": "object",
  "additionalProperties": false,
  "required": [
    "objective",
    "workflow",
    "constraints",
    "assumptions",
    "highLevelStrategy",
    "detailedPlan",
    "risks",
    "completionCriteria"
  ],
  "properties": {
    "objective": {
      "type": "string",
      "minLength": 1,
      "$comment": "RENDER: Prose under ## Objective. 1-3 sentence description of the plan's purpose."
    },

    "workflow": {
      "type": "object",
      "additionalProperties": false,
      "required": ["direction"],
      "$comment": "RENDER: '## Workflow' with 'DIRECTION: {direction}' and artifact lists",
      "properties": {
        "direction": {
          "type": "string",
          "enum": ["top-down", "bottom-up", "lateral"],
          "$comment": "top-down: REQ→DESIGN→CODE→TEST | bottom-up: CODE→DESIGN→REQ | lateral: same-level changes"
        },
        "inputArtifacts": {
          "type": "array",
          "items": {
            "type": "object",
            "additionalProperties": false,
            "required": ["type", "path"],
            "properties": {
              "type": { "type": "string", "enum": ["requirements", "design", "api", "code", "tests", "docs", "project"] },
              "path": { "type": "string" },
              "description": { "type": "string" }
            }
          },
          "$comment": "RENDER: 'INPUTS:' followed by '- [{type}] {path}: {description}'"
        },
        "outputArtifacts": {
          "type": "array",
          "items": {
            "type": "object",
            "additionalProperties": false,
            "required": ["type", "path"],
            "properties": {
              "type": { "type": "string", "enum": ["requirements", "design", "api", "code", "tests", "docs", "project"] },
              "path": { "type": "string" },
              "description": { "type": "string" }
            }
          },
          "$comment": "RENDER: 'OUTPUTS:' followed by '- [{type}] {path}: {description}'"
        }
      }
    },

    "constraints": {
      "type": "array",
      "items": { "type": "string", "minLength": 1 },
      "uniqueItems": true,
      "default": [],
      "$comment": "RENDER: Bulleted list under ## Constraints"
    },

    "assumptions": {
      "type": "array",
      "items": { "type": "string", "minLength": 1 },
      "uniqueItems": true,
      "default": [],
      "$comment": "RENDER: Bulleted list under ## Assumptions"
    },

    "highLevelStrategy": {
      "type": "array",
      "items": { "type": "string", "minLength": 1 },
      "minItems": 1,
      "$comment": "RENDER: Numbered list under ## High-Level Strategy"
    },

    "detailedPlan": {
      "type": "array",
      "items": { "$ref": "#/definitions/step" },
      "minItems": 1,
      "$comment": "RENDER: ### {id} {title} with action, rationale, and substeps"
    },

    "dependencies": {
      "type": "array",
      "items": {
        "type": "object",
        "additionalProperties": false,
        "required": ["step", "dependsOn"],
        "properties": {
          "step": { "type": "string", "minLength": 1 },
          "dependsOn": {
            "type": "array",
            "items": { "type": "string", "minLength": 1 },
            "minItems": 1
          }
        }
      },
      "default": [],
      "$comment": "RENDER: Inline as 'DEPENDS ON: {step1}, {step2}' within step sections"
    },

    "deliverables": {
      "type": "array",
      "items": {
        "type": "object",
        "additionalProperties": false,
        "required": ["name", "description", "sourceSteps"],
        "properties": {
          "name": { "type": "string", "minLength": 1 },
          "description": { "type": "string", "minLength": 1 },
          "sourceSteps": {
            "type": "array",
            "items": { "type": "string", "minLength": 1 },
            "minItems": 1
          }
        }
      },
      "default": [],
      "$comment": "RENDER: '- {NAME}: {description} (from {step1}, {step2})'"
    },

    "estimates": {
      "type": "object",
      "additionalProperties": false,
      "properties": {
        "overallEffort": { "type": "string" },
        "timeEstimates": {
          "type": "array",
          "items": {
            "type": "object",
            "additionalProperties": false,
            "required": ["step", "estimate"],
            "properties": {
              "step": { "type": "string", "minLength": 1 },
              "estimate": { "type": "string", "minLength": 1 }
            }
          }
        }
      },
      "$comment": "RENDER: 'OVERALL EFFORT: {overallEffort}' followed by '- {step}: {estimate}'"
    },

    "risks": {
      "type": "array",
      "items": {
        "type": "object",
        "additionalProperties": false,
        "required": ["risk"],
        "properties": {
          "risk": { "type": "string", "minLength": 1 },
          "impact": { "type": "string" },
          "likelihood": { "type": "string" },
          "mitigation": { "type": "string" }
        }
      },
      "default": [],
      "$comment": "RENDER: '- {RISK} [{likelihood}/{impact}]: {mitigation}'"
    },

    "completionCriteria": {
      "type": "array",
      "items": { "type": "string", "minLength": 1 },
      "minItems": 1,
      "$comment": "RENDER: Bulleted list under ## Completion Criteria"
    },

    "metadata": {
      "type": "object",
      "additionalProperties": false,
      "properties": {
        "author": { "type": "string" },
        "version": { "type": "string" },
        "date": { "type": "string", "format": "date" },
        "notes": { "type": "string" }
      },
      "$comment": "RENDER: '> VERSION: {version} | DATE: {date} | AUTHOR: {author}'"
    }
  },

  "definitions": {
    "step": {
      "type": "object",
      "additionalProperties": false,
      "required": ["id", "title", "action"],
      "$comment": "RENDER: '### {id} {title}' with action list, DEPENDS ON line, rationale, and substeps",
      "properties": {
        "id": {
          "type": "string",
          "minLength": 1,
          "$comment": "Unique identifier for referencing and dependencies"
        },
        "title": {
          "type": "string",
          "minLength": 1,
          "$comment": "Short human-readable step name"
        },
        "action": {
          "oneOf": [
            { "type": "string", "minLength": 1 },
            {
              "type": "array",
              "items": { "type": "string", "minLength": 1 },
              "minItems": 1
            }
          ],
          "$comment": "RENDER: Bulleted list of actions"
        },
        "rationale": {
          "oneOf": [
            { "type": "string" },
            {
              "type": "array",
              "items": { "type": "string" }
            }
          ],
          "$comment": "RENDER: 'RATIONALE: {rationale}'"
        },
        "notes": {
          "type": "string",
          "$comment": "RENDER: 'NOTE: {notes}'"
        },
        "substeps": {
          "type": "array",
          "items": { "$ref": "#/definitions/step" },
          "$comment": "RENDER: #### headers, indented under parent step"
        }
      }
    }
  },

  "$rendering": {
    "_comment": "Rendering specification for raw-readable markdown. Use CAPITALS for emphasis, never **bold** or *italics*. Use lists, not tables. Use mermaid, not ASCII.",
    "documentStructure": [
      "> VERSION: {version} | DATE: {date} | AUTHOR: {author}",
      "## Objective",
      "## Workflow",
      "## Constraints",
      "## Assumptions",
      "## High-Level Strategy",
      "## Detailed Plan",
      "## Deliverables",
      "## Estimates",
      "## Risks",
      "## Completion Criteria"
    ],
    "workflowTemplate": [
      "## Workflow",
      "",
      "DIRECTION: {direction}",
      "",
      "INPUTS:",
      "- [{type}] {path}: {description}",
      "",
      "OUTPUTS:",
      "- [{type}] {path}: {description}"
    ],
    "stepTemplate": [
      "### {id} {title}",
      "",
      "- {action1}",
      "- {action2}",
      "",
      "DEPENDS ON: {dep1}, {dep2}",
      "",
      "RATIONALE: {rationale}",
      "",
      "NOTE: {notes}"
    ],
    "riskTemplate": [
      "- {RISK} [{likelihood}/{impact}]: {mitigation}"
    ],
    "deliverableTemplate": [
      "- {NAME}: {description} (from {step1}, {step2})"
    ],
    "omissionRules": [
      "Omit entire section if empty/absent",
      "Omit DEPENDS ON line if no dependencies",
      "Omit RATIONALE line if rationale empty",
      "Omit NOTE line if notes empty",
      "Omit [{likelihood}/{impact}] if both absent",
      "Omit Estimates section if estimates object absent",
      "Omit Deliverables section if deliverables array empty"
    ],
    "prohibited": [
      "**bold** syntax anywhere",
      "*italic* syntax anywhere",
      "Tables (use lists instead)",
      "ASCII diagrams (use mermaid instead)",
      "FieldName: value label patterns",
      "Nested bullets for simple fields",
      "Restating design/requirement content - reference by ID only"
    ],
    "example": {
      "workflowTopDownInput": {
        "direction": "top-down",
        "inputArtifacts": [
          { "type": "requirements", "path": ".zen/specs/REQ-workspace.md", "description": "Workspace requirements" }
        ],
        "outputArtifacts": [
          { "type": "design", "path": ".zen/specs/DESIGN-workspace.md", "description": "Workspace design" },
          { "type": "code", "path": "src/workspace/config.rs", "description": "WorkspaceConfig implementation" }
        ]
      },
      "workflowTopDownOutput": "## Workflow\n\nDIRECTION: top-down\n\nINPUTS:\n- [requirements] .zen/specs/REQ-workspace.md: Workspace requirements\n\nOUTPUTS:\n- [design] .zen/specs/DESIGN-workspace.md: Workspace design\n- [code] src/workspace/config.rs: WorkspaceConfig implementation",
      "workflowBottomUpInput": {
        "direction": "bottom-up",
        "inputArtifacts": [
          { "type": "code", "path": "src/workspace/config.rs", "description": "Existing WorkspaceConfig implementation" },
          { "type": "tests", "path": "tests/workspace_test.rs", "description": "Existing workspace tests" }
        ],
        "outputArtifacts": [
          { "type": "design", "path": ".zen/specs/DESIGN-workspace.md", "description": "Document existing design" },
          { "type": "requirements", "path": ".zen/specs/REQ-workspace.md", "description": "Extract requirements from code" }
        ]
      },
      "workflowBottomUpOutput": "## Workflow\n\nDIRECTION: bottom-up\n\nINPUTS:\n- [code] src/workspace/config.rs: Existing WorkspaceConfig implementation\n- [tests] tests/workspace_test.rs: Existing workspace tests\n\nOUTPUTS:\n- [design] .zen/specs/DESIGN-workspace.md: Document existing design\n- [requirements] .zen/specs/REQ-workspace.md: Extract requirements from code",
      "stepInput": {
        "id": "S1",
        "title": "Set up project structure",
        "action": [
          "Create src/ directory with module files",
          "Initialize Cargo.toml with dependencies"
        ],
        "rationale": "Establishes foundation for subsequent implementation steps"
      },
      "stepOutput": "### S1 Set up project structure\n\n- Create src/ directory with module files\n- Initialize Cargo.toml with dependencies\n\nRATIONALE: Establishes foundation for subsequent implementation steps",
      "riskInput": {
        "risk": "API breaking changes in upstream dependency",
        "impact": "high",
        "likelihood": "medium",
        "mitigation": "Pin dependency versions and monitor changelogs"
      },
      "riskOutput": "- API BREAKING CHANGES IN UPSTREAM DEPENDENCY [medium/high]: Pin dependency versions and monitor changelogs"
    }
  }
}
